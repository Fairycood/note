# 存储器管理

## 存储器的层次结构

#### 存储组织

存储器的功能是保存数据，存储器的发展方向是**高速、大容量和大体积**

存储组织是指在存储技术和CPU寻址技术许可的范围内组织==合理的存储结构==

#### 存储层次结构

![image-20210622153949486](https://i.loli.net/2021/06/22/3epd94RzjHUOfYq.png)

#### 存储管理的功能

存储分配和回收
地址变换
存储共享和保护
存储器扩充

#### 重定位

**逻辑地址（相对地址）**：应用程序经编译后形成目标程序，再经过链接后形成可装入程序。这些程序的地址都是从0开始，程序中的其他地址都是相对于起始地址计算的，这些地址为相对地址

**物理地址（绝对地址）**：主存中一系列存储信息的物理单元的地址

**重定位**：实现逻辑地址到物理地址的映射

## 程序的装入和链接

#### 程序的装入

**1.绝对装入**：编译后，装入前已产生了绝对地址（内存地址），装入时不再作地址重定位【绝对地址的产生：由编译器完成或由程序员编程完成】

**2.可重定位装入**
2.1静态重定位：地址转换在装入时==一次==完成，由软件完成【缺点：不允许程序在运行中在内存中移动位置】
2.2动态运行时装入：动态重定位在执行时才完成相对一绝对地址的转换且有硬件的支持，能保证进程的可移动性

#### 程序的链接

1.静态链接：对相对地址的修改；变换外部调用符号
2.装入时动态链接：便于修改和更新；便于实现对目标模块的共享
3.运行时动态链接
![image-20210622162359371](https://i.loli.net/2021/06/22/Yva39rwclE64GNW.png)

## 连续分配

### 单一连续分区

![image-20210622203334677](https://i.loli.net/2021/06/22/wBfQXmdSgWbDAsy.png)

### 固定分区

![image-20210622203421830](https://i.loli.net/2021/06/22/QjClguk6NiMGrLt.png)

#### 可变式分区

根据作业的实际要求分配内存空间
![image-20210622203805839](C:/Users/13pro/AppData/Roaming/Typora/typora-user-images/image-20210622203805839.png)

#### 分配算法

**1.首次适应算法FF**：找到第一个大小满足的分区，划分。有外零头，低址内存使用频繁。要求:分区按低址-高址排序
**2.循环首次适应算法**：从1中上次找到的空闲分区的下一个开始查找。特点：空闲分区分布均匀，提高了查找速度；缺乏大的空闲分区
**3.最佳适应算法**：分区按大小递增排序；分区释放时需插入到适当位置

#### 内存回收

![image-20210622204844986](https://i.loli.net/2021/06/22/ryWcAPNKZV4DaXu.png)

### 可重定位分区分配

**紧凑**：通过作业移动将原来分散的小分区拼接成一个大分区（作业的移动需重定位）
![image-20210622211001232](https://i.loli.net/2021/06/22/XC4ZmHLjkuwJlYE.png)

### 对换

将阻塞进程，暂时不用的程序，数据换出；将具备运行条件的进程换入
类型：整体对换（进程对换，解决内存紧张）；部分对换（页面对换/分段对换）

## 离散分配

#### 页面与页表

**分页系统的基本思想**：内存分块，从0开始编号；作业分页，页与块等长，从0开始编号；内存以块为单位分配，块可不相邻。

**页面和物理块**：逻辑空间和内存空间

**地址结构**
<img src="https://i.loli.net/2021/06/23/epAQozaChncVSvw.png" alt="image-20210623102836292" style="zoom: 67%;" />

**例题**：
![image-20210623103346984](https://i.loli.net/2021/06/23/TlIbdZVQ8DFSrNJ.png)

**页表**
<img src="https://i.loli.net/2021/06/23/RPT7Jz1QAZV8K34.png" alt="image-20210623103957358" style="zoom: 50%;" />

### 地址变换机构

**基本任务**：逻辑地址——物理地址的映射
页号---->块号（通过页表来完成）
页内地址---->块内地址（无需转换）

<img src="https://i.loli.net/2021/06/23/ABdVyseC3YpFf9G.png" alt="image-20210623111716705" style="zoom:67%;" />

#### 基本地址变换机构

越界保护
每个进程对应一页表，其信息（如长度、始址）放在PCB中，执行时将其首地址装入==页表寄存器==

页表驻留在内存中
系统中设置一个页表寄存器存放页表在内存中的始址和页表的长度
**缺点：两次访问内存，速度降低近1/2**

#### 具有快表的地址变换机构

速度提高，但是快表贵，不能态度
<img src="https://i.loli.net/2021/06/23/HGFVq5CJgRpNo8Z.png" alt="image-20210623145551540" style="zoom:67%;" />

**例题**
![image-20210623150116466](https://i.loli.net/2021/06/23/VWanuI2bsw57k8T.png)

## 两级和多级页表

页表可能很大（超过一页），将其离散存放在不太块中
建一“外部页表”来管理这些离散页表块
<img src="https://i.loli.net/2021/06/23/Mj2lhfIvkKYd4a6.png" alt="image-20210623151218373" style="zoom:50%;" />
<img src="https://i.loli.net/2021/06/23/wjWN8M2b49v5TFz.png" alt="image-20210623152704097" style="zoom:67%;" />

**例题**
<img src="https://i.loli.net/2021/06/23/fQ8mdU4GqHyoWTx.png" alt="image-20210623152044372" style="zoom: 67%;" />

此题型步骤：先算内存分块情况，再算作业分页请况

## 基本分段存储管理

**引入**：页是物理单位

**分段的基本思想**：按程序的逻辑结构，将程序的地址空间划分为若干段，各段大小可不相同；内存以段为单位分配，这些段在内存中可以不相邻接。

分段地址中的地址具有如下结构：![image-20210624101949410](https://i.loli.net/2021/06/24/yW5eOHR4gFAspDU.png)

**段表**
<img src="https://i.loli.net/2021/06/24/DqwnHpx3S6IQ5LW.png" alt="image-20210624102022106" style="zoom: 50%;" />

**地址变换结构**<img src="https://i.loli.net/2021/06/24/lG8oXNDiRHqy59k.png" alt="image-20210624102053243" style="zoom: 50%;" />

**分页和分段的主要区别**：页是信息的物理单位，段是逻辑单位；页长度固定，段长度是固定的（有用户指定）；一维与二维；分段系统更简单，更方便

**段式管理的优点**：程序的各段可独立编译（修改一个过程不会影响其他无关过程）；可采用不同的保护措施（段只包含一种类型的对象，可以有针对这种特定类型的合适的保护）；便于共享某些段（常见的例子是共享库，如图形库）

**缺点**：段长受限制（段长不定，会出现空闲区上内存的浪费）；段是作为一个整体调入调出，操作时间长

## 段页式存储管理方式

**分页优点**：提高内存利用率
**分段优点**：方便用户，易于共享，保护，动态链接

**段页式系统基本原理**：内存分为长度相等的若干块；作业分段，段内分页，页长等于块长；内存以块为单位分配

**段表&页表**
<img src="https://i.loli.net/2021/06/24/YDdGx3BkuiJ6rzt.png" alt="image-20210624104004409" style="zoom:67%;" />

**地址变换机构**
<img src="https://i.loli.net/2021/06/24/NH5GroKa42juDIM.png" alt="image-20210624104123370" style="zoom:50%;" />

# 虚拟存储器

**虚拟存储器**：具有==请求调入==功能和==置换==功能，能从逻辑上对内存容量进行扩充的一种存储系统。
**实质**：以时间换空间，但时间牺牲不大

**实现方式**：
<img src="https://i.loli.net/2021/06/24/hltDaC469OMxuH8.png" alt="image-20210624115854421" style="zoom:50%;" />

**特征**：离散型：部分装入（若连续则不可能提供虚存）；多次性：局部装入，多次装入；对换性；虚拟性。

## 请求分页系统

#### 请求分页中的硬件支持

**页表机制**：<img src="https://i.loli.net/2021/06/24/IqY9biRMzwVrg35.png" alt="image-20210624122352921" style="zoom:67%;" />

**缺页中断机制**：可在指令执行期间产生，转入缺页中断处理程序
<img src="https://i.loli.net/2021/06/24/1MFi4OKN9jugtIy.png" alt="image-20210624122620035" style="zoom:50%;" />

**地址变换机构**
<img src="https://i.loli.net/2021/06/24/TDnHgoaSx6CQB7b.png" alt="image-20210624122650648" style="zoom:80%;" />

#### 内存分配策略和分配算法

**最小物理块数**：不同的作业要求不同

**页面分配和置换策略**：
1.固定分配局部置换（缺点：难以确定固定分配的页数）2.可变分配全局置换 3.可变分配全局置换（根据进程的缺页率进行页面数调整，进程之间相互不会影响）

**分配算法**：
1.平均分配算法
2.按进程大小比例分配算法：<img src="https://i.loli.net/2021/06/24/ZMgPuDV3hOT1SL9.png" alt="image-20210624123940234" style="zoom: 50%;" />

3.考虑优先权分配算法

#### 页面调入策略

<img src="https://i.loli.net/2021/06/24/o8tBSEujmh5KALG.png" alt="image-20210624124146823" style="zoom:67%;" />

