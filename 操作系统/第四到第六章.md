# 存储器管理

## 存储器的层次结构

#### 存储组织

存储器的功能是保存数据，存储器的发展方向是**高速、大容量和大体积**

存储组织是指在存储技术和CPU寻址技术许可的范围内组织==合理的存储结构==

#### 存储层次结构

![image-20210622153949486](https://i.loli.net/2021/06/22/3epd94RzjHUOfYq.png)

#### 存储管理的功能

存储分配和回收
地址变换
存储共享和保护
存储器扩充

#### 重定位

**逻辑地址（相对地址）**：应用程序经编译后形成目标程序，再经过链接后形成可装入程序。这些程序的地址都是从0开始，程序中的其他地址都是相对于起始地址计算的，这些地址为相对地址

**物理地址（绝对地址）**：主存中一系列存储信息的物理单元的地址

**重定位**：实现逻辑地址到物理地址的映射

## 程序的装入和链接

#### 程序的装入

**1.绝对装入**：编译后，装入前已产生了绝对地址（内存地址），装入时不再作地址重定位【绝对地址的产生：由编译器完成或由程序员编程完成】

**2.可重定位装入**
2.1静态重定位：地址转换在装入时==一次==完成，由软件完成【缺点：不允许程序在运行中在内存中移动位置】
2.2动态运行时装入：动态重定位在执行时才完成相对一绝对地址的转换且有硬件的支持，能保证进程的可移动性

#### 程序的链接

1.静态链接：对相对地址的修改；变换外部调用符号
2.装入时动态链接：便于修改和更新；便于实现对目标模块的共享
3.运行时动态链接
![image-20210622162359371](https://i.loli.net/2021/06/22/Yva39rwclE64GNW.png)

## 连续分配

### 单一连续分区

![image-20210622203334677](https://i.loli.net/2021/06/22/wBfQXmdSgWbDAsy.png)

### 固定分区

![image-20210622203421830](https://i.loli.net/2021/06/22/QjClguk6NiMGrLt.png)

#### 可变式分区

根据作业的实际要求分配内存空间
![image-20210622203805839](C:/Users/13pro/AppData/Roaming/Typora/typora-user-images/image-20210622203805839.png)

#### 分配算法

**1.首次适应算法FF**：找到第一个大小满足的分区，划分。有外零头，低址内存使用频繁。要求:分区按低址-高址排序
**2.循环首次适应算法**：从1中上次找到的空闲分区的下一个开始查找。特点：空闲分区分布均匀，提高了查找速度；缺乏大的空闲分区
**3.最佳适应算法**：分区按大小递增排序；分区释放时需插入到适当位置

#### 内存回收

![image-20210622204844986](https://i.loli.net/2021/06/22/ryWcAPNKZV4DaXu.png)

### 可重定位分区分配

**紧凑**：通过作业移动将原来分散的小分区拼接成一个大分区（作业的移动需重定位）
![image-20210622211001232](https://i.loli.net/2021/06/22/XC4ZmHLjkuwJlYE.png)

### 对换

将阻塞进程，暂时不用的程序，数据换出；将具备运行条件的进程换入
类型：整体对换（进程对换，解决内存紧张）；部分对换（页面对换/分段对换）

## 离散分配

#### 页面与页表

**分页系统的基本思想**：内存分块，从0开始编号；作业分页，页与块等长，从0开始编号；内存以块为单位分配，块可不相邻。

**页面和物理块**：逻辑空间和内存空间

**地址结构**
<img src="https://i.loli.net/2021/06/23/epAQozaChncVSvw.png" alt="image-20210623102836292" style="zoom: 67%;" />

**例题**：
![image-20210623103346984](https://i.loli.net/2021/06/23/TlIbdZVQ8DFSrNJ.png)

**页表**
<img src="https://i.loli.net/2021/06/23/RPT7Jz1QAZV8K34.png" alt="image-20210623103957358" style="zoom: 50%;" />

### 地址变换机构

**基本任务**：逻辑地址——物理地址的映射
页号---->块号（通过页表来完成）
页内地址---->块内地址（无需转换）

<img src="https://i.loli.net/2021/06/23/ABdVyseC3YpFf9G.png" alt="image-20210623111716705" style="zoom:67%;" />

#### 基本地址变换机构

越界保护
每个进程对应一页表，其信息（如长度、始址）放在PCB中，执行时将其首地址装入==页表寄存器==

页表驻留在内存中
系统中设置一个页表寄存器存放页表在内存中的始址和页表的长度
**缺点：两次访问内存，速度降低近1/2**

#### 具有快表的地址变换机构

速度提高，但是快表贵，不能态度
<img src="https://i.loli.net/2021/06/23/HGFVq5CJgRpNo8Z.png" alt="image-20210623145551540" style="zoom:67%;" />

**例题**
![image-20210623150116466](https://i.loli.net/2021/06/23/VWanuI2bsw57k8T.png)

## 两级和多级页表

页表可能很大（超过一页），将其离散存放在不太块中
建一“外部页表”来管理这些离散页表块
<img src="https://i.loli.net/2021/06/23/Mj2lhfIvkKYd4a6.png" alt="image-20210623151218373" style="zoom:50%;" />
<img src="https://i.loli.net/2021/06/23/wjWN8M2b49v5TFz.png" alt="image-20210623152704097" style="zoom:67%;" />

**例题**
<img src="https://i.loli.net/2021/06/23/fQ8mdU4GqHyoWTx.png" alt="image-20210623152044372" style="zoom: 67%;" />

此题型步骤：先算内存分块情况，再算作业分页请况

## 基本分段存储管理

**引入**：页是物理单位

**分段的基本思想**：按程序的逻辑结构，将程序的地址空间划分为若干段，各段大小可不相同；内存以段为单位分配，这些段在内存中可以不相邻接。

分段地址中的地址具有如下结构：![image-20210624101949410](https://i.loli.net/2021/06/24/yW5eOHR4gFAspDU.png)

**段表**
<img src="https://i.loli.net/2021/06/24/DqwnHpx3S6IQ5LW.png" alt="image-20210624102022106" style="zoom: 50%;" />

**地址变换结构**<img src="https://i.loli.net/2021/06/24/lG8oXNDiRHqy59k.png" alt="image-20210624102053243" style="zoom: 50%;" />

**分页和分段的主要区别**：页是信息的物理单位，段是逻辑单位；页长度固定，段长度是固定的（有用户指定）；一维与二维；分段系统更简单，更方便

**段式管理的优点**：程序的各段可独立编译（修改一个过程不会影响其他无关过程）；可采用不同的保护措施（段只包含一种类型的对象，可以有针对这种特定类型的合适的保护）；便于共享某些段（常见的例子是共享库，如图形库）

**缺点**：段长受限制（段长不定，会出现空闲区上内存的浪费）；段是作为一个整体调入调出，操作时间长

## 段页式存储管理方式

**分页优点**：提高内存利用率
**分段优点**：方便用户，易于共享，保护，动态链接

**段页式系统基本原理**：内存分为长度相等的若干块；作业分段，段内分页，页长等于块长；内存以块为单位分配

**段表&页表**
<img src="https://i.loli.net/2021/06/24/YDdGx3BkuiJ6rzt.png" alt="image-20210624104004409" style="zoom:67%;" />

**地址变换机构**
<img src="https://i.loli.net/2021/06/24/NH5GroKa42juDIM.png" alt="image-20210624104123370" style="zoom:50%;" />

# 虚拟存储器

**虚拟存储器**：具有==请求调入==功能和==置换==功能，能从逻辑上对内存容量进行扩充的一种存储系统。
**实质**：以时间换空间，但时间牺牲不大

**实现方式**：
<img src="https://i.loli.net/2021/06/24/hltDaC469OMxuH8.png" alt="image-20210624115854421" style="zoom:50%;" />

**特征**：离散型：部分装入（若连续则不可能提供虚存）；多次性：局部装入，多次装入；对换性；虚拟性。

## 请求分页系统

#### 请求分页中的硬件支持

**页表机制**：<img src="https://i.loli.net/2021/06/24/IqY9biRMzwVrg35.png" alt="image-20210624122352921" style="zoom:67%;" />

**缺页中断机制**：可在指令执行期间产生，转入缺页中断处理程序
<img src="https://i.loli.net/2021/06/24/1MFi4OKN9jugtIy.png" alt="image-20210624122620035" style="zoom:50%;" />

**地址变换机构**
<img src="https://i.loli.net/2021/06/24/TDnHgoaSx6CQB7b.png" alt="image-20210624122650648" style="zoom:80%;" />

#### 内存分配策略和分配算法

**最小物理块数**：不同的作业要求不同

**页面分配和置换策略**：
1.固定分配局部置换（缺点：难以确定固定分配的页数）2.可变分配全局置换 3.可变分配局部置换（根据进程的缺页率进行页面数调整，进程之间相互不会影响）

**分配算法**：
1.平均分配算法

2.按进程大小比例分配算法：<img src="https://i.loli.net/2021/06/24/ZMgPuDV3hOT1SL9.png" alt="image-20210624123940234" style="zoom: 50%;" />

3.考虑优先权分配算法

#### 页面调入策略

<img src="https://i.loli.net/2021/06/24/o8tBSEujmh5KALG.png" alt="image-20210624124146823" style="zoom:67%;" />

**例题**
<img src="https://i.loli.net/2021/06/24/GypNOM7FKE23JcC.png" alt="image-20210624155723264" style="zoom: 67%;" /><img src="https://i.loli.net/2021/06/24/Is5GaCFeqUJVdEZ.png" alt="image-20210624155735208" style="zoom: 67%;" /><img src="https://i.loli.net/2021/06/24/wrm92CBAZPlO7gS.png" alt="image-20210624155801856" style="zoom: 67%;" />

### 页面置换算法

#### 最佳置换算法（OPT）

选择的被淘汰页面，将是以后永不使用的，或许是在最长（未来）时间内不再访问的页面
<img src="https://i.loli.net/2021/06/24/vLBzHJoQCneO5SG.png" alt="image-20210624161634888" style="zoom:67%;" />

#### 先进先出（FIFO）页面置换算法

<img src="https://i.loli.net/2021/06/24/VsvQEkFcBbLownl.png" alt="image-20210624161832550" style="zoom:67%;" />

#### 最近最久未使用（LRU）置换算法

<img src="https://i.loli.net/2021/06/24/6mz9coAeDfLqCRk.png" alt="image-20210624161937403" style="zoom:67%;" />

**LRU置换算法的硬件支持**
1.寄存器：为了记录某进程在内存中各页的使用情况，须为每个在内存中的页面配置一个移位寄存器
2.栈：用栈保存当前使用页面时栈的变化情况

**影响缺页率的因素**：页面大小；进程所分配物理块的数目；页面置换算法；程序固有特性

#### Clock置换算法（近似LRU）

**简单的Clock置换算法**
![image-20210624163341435](https://i.loli.net/2021/06/24/2aCGVrQx8RXKej6.png)

#### 改进型Clock置换算法

<img src="https://i.loli.net/2021/06/24/wW1GdHjEFLPb4Sn.png" alt="image-20210624170155988" style="zoom:50%;" />

**执行过程可分为以下三步**：
1.从指针所指示的当前位置开始，扫描循环队列，寻找第一类页面，讲所遇到的第一个页面作为所选中的淘汰页。在第一次扫描期间不改变访问位A

2.如果第一步失败，即查找一轮后未一到第一类页面，则开始第二轮扫描，寻找第二类页面，讲遇到的第一个这类页面作为淘汰页。在第二轮扫描期间，讲所有扫描过的页面访问位都置0

3.如果第二步也失败，即未找到第二类页面，则讲指针返回到开始的位置，并将所有的访问位复0。然后重复第一步，如果扔失败，必要时再重复第二步，此时就一定能找到被淘汰的页

### 请求分页系统的性能分析

请求分页系统是目前最常用的一种存储方式，但运行中产生的缺页情况会影响速度和系统性能，而缺页率的高低往往与进程所占用的物理块数有关。

**1.缺页率与有效访问时间**
<img src="https://i.loli.net/2021/06/24/vQKni2l7fDdkeq3.png" alt="image-20210624174221409" style="zoom:50%;" />

**2.抖动**
一种系统状态，即系统花在页面替换上的时间远远大于执行进程的时间

**产生原因**：由于分配给进程的页面数大小少于进程所需要的最低页面数，导致出现连接不断的缺页中断，引起抖动

**CPU利用率与多道程序度的关系**：多道程序指在内存中并发执行的程序数目。两者关系：在低度情况下，CPU利用率呈线性变化关系。随着度的上升，CPU利用率也逐渐上升，最终上升到一个最大值，若在这种情况下，进一步增加度，则系统发生抖动，且CPU利用率将迅速恶化

**结论**：系统可以利用CPU利用率与多道程序度进行比较的方法检测抖动，一旦发生抖动，可以通过减少多道程序度的方法来消除

## 请求分段系统

#### 请求分段中的硬件支持

**段表机制**：<img src="https://i.loli.net/2021/06/24/X6DtnLuNUwRHk14.png" alt="image-20210624204312736" style="zoom:67%;" />

**缺段中断机制**：
<img src="C:/Users/13pro/AppData/Roaming/Typora/typora-user-images/image-20210624204342930.png" alt="image-20210624204342930" style="zoom:67%;" />

**地址变换机构**：
<img src="https://i.loli.net/2021/06/25/WhHEdOJMn2Cp8Q1.png" alt="image-20210625105230978" style="zoom:50%;" />

#### 分段的共享与保护

**1.共享段表**
<img src="https://i.loli.net/2021/06/25/eHwZbF7qN2hTrdW.png" alt="image-20210625194116879" style="zoom: 50%;" />

**2.共享段的分配与回收**
1) 共享段的分配：
共享段只分配1次内存，第一个请求使用该共享段的进程，由系统为该共享段分配内存，始址填入请求进程的段表的相应项中，==还须在共享段表中增加一表项，填写有关数据，把count置为1==；之后，当又有其它进程需要调用该共享段时，只需在调用进程的段表中，增加一表项，填写该共享段的物理地址；在共享段的段表中，填上调用进程的进程名、存取控制等，再执行count++操作，以表明有两个进程共享该段。

2) 共享段的回收：
共享段只回收1次。某进程不再需要该段时，撤在该进程段表中共享段所对应的表项，以及执行count--，若结果为0，则须由系统回收该共享段的物理内存。

**3.分段保护**
1.越界检查

2. 存取控制检查
只读只执行读/写
3.环保护机构
一个程序可以访问驻留在相同环或较低特权环中的数据
一个程序可以调用驻留在相同环或较高特权环中的服务

# 输入输出系统

**基本功能**：完成用户I/O请求，提高I/O速度和利用率

**I/O系统的层次结构，模型和接口**
![image-20210625202039629](https://i.loli.net/2021/06/25/RvkW9xMUosmSPyd.png)

## I/O设备和控制器

#### I/O设备

**类型**：
<img src="https://i.loli.net/2021/06/25/IV7ZR5Ww3lEeFPY.png" alt="image-20210625203142907" style="zoom: 50%;" />

**设备与控制器之间的接口**
<img src="https://i.loli.net/2021/06/25/GDNiEa6xpjq4Wlu.png" alt="image-20210625203300847" style="zoom:50%;" />

#### 设备控制器

**设备控制器的基本功能**：接受CPU命令，控制I/O设备工作，解放CPU
1.接受和识别命令；2.数据交换（数据寄存器）；3.设备状态的了解和报告（状态寄存器）；4.地址识别（CPU通过“地址”与设备通信，设备控制器应能识别它所控制的设备地址以及其各寄存器的地址）；5.数据缓冲；6.差错控制

**设备控制器的组成**
<img src="https://i.loli.net/2021/06/25/dfcZ7B6JTbiF2z8.png" alt="image-20210625203915729" style="zoom: 67%;" />

#### 内存映像I/O

![image-20210625205854062](https://i.loli.net/2021/06/25/a8kfbtOyhleijc3.png)

#### I/O通道

**引入目的**：解脱CPU对I/O的组织、管理

**通道**：一种特殊的执行I/O指令的处理机，与CPU共享内存，可以有自己的总线

CPU只需发送I/O命令各通道，通道建立通道程序，并执行通道程序完成I/O任务

<img src="https://i.loli.net/2021/06/25/GQutYK8F4zrvDoU.png" alt="image-20210625210335768" style="zoom:67%;" />

**字节多路通道**：各子通道以时间片转换方式共享通道，适用于低、中速设备
**数组选择通道**：无子通道，仅一主通道，某时间由某设备独占，适于高速设备，但通信未共享，利用率低
**数组多路通道**：在上图中，多子通道不是以时间片方式，而是“按需分配”，综合了以前2种通道类型的优点

**瓶颈问题**
<img src="https://i.loli.net/2021/06/25/elcDNpR7jSBryTk.png" alt="image-20210625211526755" style="zoom: 67%;" />

#### 总线系统

**微机I/O系统**
<img src="https://i.loli.net/2021/06/25/9NdwTACGq2BXjfR.png" alt="image-20210625212649235" style="zoom:50%;" />

CPU―设备控制器―设备
设备控制器与设备是一对多的关系，系统是通过它与设备通信
如：磁盘设备，打印设备
缺点：总线瓶颈，CPU瓶颈。

**主机I/O系统（四级结构）**
<img src="https://i.loli.net/2021/06/25/59ZTPcXODAmzfpG.png" alt="image-20210625212745888" style="zoom:50%;" />

计算机―I/O通道―I/O控制器―设备
I/O通道相当于对总线的扩展，即多总线方式，且通道有一定的智能性，能与CPU并行，解决其负担

## 中断机构和中断处理程序

**中断**：CPU对I/O设备发来的中断信号的一种响应（外中断）

**陷入**：内中断

<img src="https://i.loli.net/2021/06/25/K7bVWGlZTYBN6dz.png" alt="image-20210625213422509" style="zoom:50%;" />

## 设备驱动程序

